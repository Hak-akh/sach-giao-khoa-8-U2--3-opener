<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>English Quiz - Environment & Healthy Lifestyle</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX transformation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f5f9; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
<script type="importmap">
{
  "imports": {
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "react": "https://aistudiocdn.com/react@^19.2.0"
  }
}
</script>
</head>
<body class="bg-slate-50 text-slate-900 min-h-screen selection:bg-teal-100 selection:text-teal-900">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef, useMemo } = React;

        // ==========================================
        // 1. TYPES & CONSTANTS
        // ==========================================
        const QuestionType = {
            ListenWrite: 'listen-write',
            Match: 'match',
            Fill: 'fill',
            MCQ: 'mcq',
            ShortAnswer: 'short-answer',
            Writing: 'writing',
            Listening: 'listening',
            SentenceScramble: 'sentence-scramble'
        };

        // ==========================================
        // 2. SERVICES (TTS)
        // ==========================================
        let selectedVoice = null;

        const getAvailableVoices = () => {
            if (!window.speechSynthesis) return [];
            return window.speechSynthesis.getVoices().filter(voice => voice.lang.startsWith('en'));
        };

        const setPreferredVoice = (voiceName) => {
            const voices = getAvailableVoices();
            const found = voices.find(v => v.name === voiceName);
            if (found) {
                selectedVoice = found;
            }
        };

        const playTTS = (text) => {
            if (!window.speechSynthesis) {
                alert("Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ƒë·ªçc vƒÉn b·∫£n.");
                return;
            }
            window.speechSynthesis.cancel();
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;

            if (selectedVoice) {
                utterance.voice = selectedVoice;
            } else {
                const voices = getAvailableVoices();
                const defaultVoice = voices.find(v => v.name === 'Google US English') || 
                                     voices.find(v => v.lang === 'en-US') ||
                                     voices[0];
                if (defaultVoice) utterance.voice = defaultVoice;
            }
            window.speechSynthesis.speak(utterance);
        };

        // ==========================================
        // 3. DATA (UNITS)
        // ==========================================
        
        // --- UNIT 3 (OLD): THE ENVIRONMENT ---
        const unit3EnvVocab = [
            { word: 'sea', ipa: '/siÀê/', meaning: 'bi·ªÉn', example: 'The sea is becoming polluted.' },
            { word: 'rainforests', ipa: '/Ààre…™nf…ír…™sts/', meaning: 'r·ª´ng nhi·ªát ƒë·ªõi', example: 'Rainforests are disappearing.' },
            { word: 'rivers', ipa: '/Ààr…™v…ôrz/', meaning: 's√¥ng', example: 'Many rivers dry up in summer.' },
            { word: 'lakes', ipa: '/le…™ks/', meaning: 'h·ªì', example: 'The lake is full of fish.' },
            { word: 'air', ipa: '/e…ô(r)/', meaning: 'kh√¥ng kh√≠', example: 'We need fresh air to breathe.' },
            { word: 'ice caps', ipa: '/Ààa…™s k√¶ps/', meaning: 'ch·ªèm bƒÉng', example: 'Ice caps are melting due to global warming.' },
            { word: 'become polluted', ipa: '/p…ôÀàluÀêt…™d/', meaning: 'tr·ªü n√™n √¥ nhi·ªÖm', example: 'The river has become polluted.' },
            { word: 'dry up', ipa: '/dra…™  åp/', meaning: 'c·∫°n ki·ªát / kh√¥ c·∫°n', example: 'The stream might dry up soon.' },
            { word: 'disappear', ipa: '/d…™s…ôÀàp…™…ô(r)/', meaning: 'bi·∫øn m·∫•t', example: 'Many species will disappear.' },
            { word: 'melt', ipa: '/melt/', meaning: 'tan ch·∫£y', example: 'Ice melts when it is hot.' }
        ];

        const unit3EnvQuestions = [
            {
                id: `u3-vocab-write-1`,
                type: QuestionType.ListenWrite,
                title: `1. T·ª´ v·ª±ng: Nghe v√† Vi·∫øt`,
                prompt: 'Nghe t·ª´ v·ª±ng, nh√¨n phi√™n √¢m v√† g√µ l·∫°i ch√≠nh x√°c t·ª´ ƒë√≥.',
                audioText: 'rainforests',
                display: '/Ààre…™nf…ír…™sts/',
                answer: 'rainforests',
                explanation: `T·ª´ ƒë√∫ng l√† <b>"rainforests"</b>. Nghƒ©a ti·∫øng Vi·ªát: r·ª´ng nhi·ªát ƒë·ªõi.`,
            },
            {
                id: 'u3-vocab-match',
                type: QuestionType.Match,
                title: '2. T·ª´ v·ª±ng: N·ªëi t·ª´ v·ªõi nghƒ©a',
                description: 'Gh√©p t·ª´ v·ª±ng ti·∫øng Anh v·ªõi nghƒ©a ti·∫øng Vi·ªát t∆∞∆°ng ·ª©ng.',
                explanation: 'H√£y h·ªçc thu·ªôc b·∫£ng t·ª´ v·ª±ng ƒë·ªÉ l√†m t·ªët ph·∫ßn n√†y.',
                items: [
                    { id: 'A1', A: 'rainforests', B: 'r·ª´ng m∆∞a nhi·ªát ƒë·ªõi' },
                    { id: 'A2', A: 'dry up', B: 'c·∫°n kh√¥ / c·∫°n ki·ªát' },
                    { id: 'A3', A: 'melt', B: 'tan ch·∫£y' },
                    { id: 'A4', A: 'become polluted', B: 'tr·ªü n√™n √¥ nhi·ªÖm' },
                    { id: 'A5', A: 'ice caps', B: 'ch·ªèm bƒÉng' },
                    { id: 'A6', A: 'disappear', B: 'bi·∫øn m·∫•t' },
                    { id: 'A7', A: 'rivers', B: 's√¥ng' },
                ],
            },
            {
                id: 'u3-fill-blanks',
                type: QuestionType.Fill,
                title: '3. Ng·ªØ c·∫£nh: ƒêi·ªÅn v√†o ch·ªó tr·ªëng',
                explanation: 'D·ª±a v√†o c√°c c·ª•m t·ª´ collocations trong b√†i h·ªçc: "rivers dry up", "ice caps melt", "air becomes polluted".',
                options: ['environment', 'polluted', 'dry up', 'disappear', 'lakes', 'melt'],
                questions: [
                    { text: 'The air becomes __ because of smoke from cars and factories.', answer: 'polluted', explanation: 'Kh√¥ng kh√≠ tr·ªü n√™n √¥ nhi·ªÖm (polluted) do kh√≥i b·ª•i.' },
                    { text: 'In the dry season, some rivers and lakes __.', answer: 'dry up', explanation: 'V√†o m√πa kh√¥, s√¥ng h·ªì c·∫°n ki·ªát (dry up).' },
                    { text: 'Global warming makes ice caps __.', answer: 'melt', explanation: 'N√≥ng l√™n to√†n c·∫ßu l√†m ch·ªèm bƒÉng tan ch·∫£y (melt).' },
                    { text: 'If we cut down trees, rainforests will __.', answer: 'disappear', explanation: 'N·∫øu ch·∫∑t c√¢y, r·ª´ng s·∫Ω bi·∫øn m·∫•t (disappear).' },
                    { text: 'We need to protect our __.', answer: 'environment', explanation: 'Ch√∫ng ta c·∫ßn b·∫£o v·ªá m√¥i tr∆∞·ªùng (environment).' },
                ],
            },
            {
                id: 'u3-scramble-1',
                type: QuestionType.SentenceScramble,
                title: '4. S·∫Øp x·∫øp c√¢u (Nghe v√† X·∫øp)',
                prompt: 'Nghe v√† s·∫Øp x·∫øp c√°c t·ª´ sau th√†nh c√¢u ho√†n ch·ªânh v·ªÅ b·∫£o v·ªá m√¥i tr∆∞·ªùng.',
                audioText: 'If we pollute the rivers fish will die',
                segments: ['the rivers,', 'If', 'fish', 'will die.', 'we pollute'],
                correctOrder: ['If', 'we pollute', 'the rivers,', 'fish', 'will die.'],
                explanation: 'C·∫•u tr√∫c c√¢u ƒëi·ªÅu ki·ªán lo·∫°i 1: <br><b>If + S + V (hi·ªán t·∫°i), S + will + V (nguy√™n th·ªÉ).</b><br>D·ªãch: N·∫øu ch√∫ng ta l√†m √¥ nhi·ªÖm c√°c d√≤ng s√¥ng, c√° s·∫Ω ch·∫øt.',
            }
        ];

        // --- UNIT 2: DISASTERS & ACCIDENTS ---
        const unit2Vocab = [
            { word: 'tsunami', ipa: '/tsuÀêÀàn…ëÀêmi/', meaning: 's√≥ng th·∫ßn', example: 'A huge tsunami hit the coast.' },
            { word: 'earthquake', ipa: '/Àà…úÀêŒ∏kwe…™k/', meaning: 'ƒë·ªông ƒë·∫•t', example: 'The building shook during the earthquake.' },
            { word: 'landslide', ipa: '/Ààl√¶ndsla…™d/', meaning: 's·∫°t l·ªü ƒë·∫•t', example: 'Heavy rain caused a landslide.' },
            { word: 'flood', ipa: '/fl åd/', meaning: 'l≈© l·ª•t', example: 'The flood covered the town in water.' },
            { word: 'storm', ipa: '/st…îÀêm/', meaning: 'b√£o', example: 'The storm destroyed many houses.' },
            { word: 'volcanic eruption', ipa: '/v…ílÀàk√¶n…™k …™Ààr åp Én/', meaning: 'phun tr√†o n√∫i l·ª≠a', example: 'The volcanic eruption was terrifying.' },
            { word: 'explosion', ipa: '/…™kÀàspl…ô ä ín/', meaning: 'v·ª• n·ªï', example: 'We heard a loud explosion.' },
            { word: 'shipwreck', ipa: '/Àà É…™prek/', meaning: 'ƒë·∫Øm t√†u', example: 'Divers explored the shipwreck.' },
            { word: 'crash', ipa: '/kr√¶ É/', meaning: 'v·ª• va ch·∫°m', example: 'There was a car crash on the road.' },
            { word: 'terrified', ipa: '/Ààter…™fa…™d/', meaning: 'khi·∫øp s·ª£', example: 'She was terrified of the storm.' },
            { word: 'relieved', ipa: '/r…™ÀàliÀêvd/', meaning: 'nh·∫π nh√µm', example: 'I felt relieved when it stopped.' },
            { word: 'worried', ipa: '/Ààw årid/', meaning: 'lo l·∫Øng', example: 'He is worried about the future.' }
        ];

        const unit2Questions = [
            {
                id: 'u2-match-disasters',
                type: QuestionType.Match,
                title: '1. Vocabulary: Label the pictures',
                description: 'N·ªëi t√™n th·∫£m h·ªça v·ªõi m√¥ t·∫£ t∆∞∆°ng ·ª©ng.',
                explanation: 'C√°c th·∫£m h·ªça thi√™n nhi√™n ch√≠nh: Earthquake (ƒê·ªông ƒë·∫•t), Tsunami (S√≥ng th·∫ßn), Flood (L≈© l·ª•t)...',
                items: [
                    { id: 'A1', A: 'tsunami', B: 'S√≥ng th·∫ßn (Huge waves)' },
                    { id: 'A2', A: 'earthquake', B: 'ƒê·ªông ƒë·∫•t (Ground shaking)' },
                    { id: 'A3', A: 'landslide', B: 'S·∫°t l·ªü ƒë·∫•t (Earth falling down)' },
                    { id: 'A4', A: 'flood', B: 'L≈© l·ª•t (Water covering land)' },
                    { id: 'A5', A: 'storm', B: 'B√£o (Strong wind and rain)' },
                    { id: 'A6', A: 'volcanic eruption', B: 'Phun tr√†o n√∫i l·ª≠a' }
                ]
            },
            {
                id: 'u2-guess-words',
                type: QuestionType.Fill,
                title: '2. Vocabulary: Guess the words',
                explanation: 'D·ª±a v√†o g·ª£i √Ω ƒë·ªÉ ƒëo√°n t·ª´ v·ª±ng v·ªÅ tai n·∫°n.',
                options: ['explosion', 'fire', 'plane crash', 'shipwreck', 'car crash'],
                questions: [
                    { text: 'A sudden loud noise ‚Üí __', answer: 'explosion', explanation: 'Ti·∫øng ·ªìn l·ªõn ƒë·ªôt ng·ªôt -> V·ª• n·ªï.' },
                    { text: 'A big accident involving burning in a building ‚Üí __', answer: 'fire', explanation: 'Tai n·∫°n li√™n quan ƒë·∫øn ch√°y -> H·ªèa ho·∫°n.' },
                    { text: 'A plane hits the ground ‚Üí __', answer: 'plane crash', explanation: 'M√°y bay ƒë√¢m xu·ªëng ƒë·∫•t -> R∆°i m√°y bay.' },
                    { text: 'A ship sinks ‚Üí __', answer: 'shipwreck', explanation: 'T√†u ch√¨m -> ƒê·∫Øm t√†u.' },
                    { text: 'A car hits another car ‚Üí __', answer: 'car crash', explanation: 'Xe h∆°i ƒë√¢m nhau -> Tai n·∫°n √¥ t√¥.' }
                ]
            },
            {
                id: 'u2-listening',
                type: QuestionType.Fill,
                title: '3. Listening: Gap Fill',
                prompt: 'Nghe ƒëo·∫°n h·ªôi tho·∫°i v√† ƒëi·ªÅn v√†o ch·ªó tr·ªëng.',
                audioText: 'I was in the kitchen when I heard a loud noise. It was a plane crash nearby. I looked out and saw smoke and fire everywhere. Luckily, only the pilot got injured. I feel relieved now because I was safe inside.',
                explanation: 'Nghe k·ªπ c√°c t·ª´ kh√≥a v·ªÅ ƒë·ªãa ƒëi·ªÉm, s·ª± ki·ªán v√† c·∫£m x√∫c.',
                options: ['kitchen', 'plane crash', 'fire', 'The pilot', 'safe'],
                questions: [
                    { text: 'Jane heard a loud noise when she was in her __.', answer: 'kitchen', explanation: 'C√¥ ·∫•y ·ªü trong b·∫øp (kitchen).' },
                    { text: 'The accident was a __.', answer: 'plane crash', explanation: 'Tai n·∫°n r∆°i m√°y bay (plane crash).' },
                    { text: 'She saw smoke and __.', answer: 'fire', explanation: 'Kh√≥i v√† l·ª≠a (fire).' },
                    { text: '__ got injured.', answer: 'The pilot', explanation: 'Phi c√¥ng b·ªã th∆∞∆°ng.' },
                    { text: 'She feels relieved now because she was __.', answer: 'safe', explanation: 'C√¥ ·∫•y an to√†n (safe).' }
                ]
            }
        ];

        // --- UNIT 3 (NEW): HEALTHY LIFESTYLE ---
        const unit3HealthyVocab = [
            { word: 'work out', ipa: '/w…úÀêk a ät/', meaning: 't·∫≠p th·ªÉ d·ª•c/th·ªÉ thao', example: 'I work out every morning.' },
            { word: 'workout', ipa: '/Ààw…úÀêka ät/', meaning: 'bu·ªïi t·∫≠p th·ªÉ d·ª•c', example: 'That was a tough workout.' },
            { word: 'calorie', ipa: '/Ààk√¶l…ôri/', meaning: 'calo (nƒÉng l∆∞·ª£ng)', example: 'Running burns a lot of calories.' },
            { word: 'beneficial', ipa: '/Àåben…™Ààf…™ Él/', meaning: 'c√≥ l·ª£i, c√≥ √≠ch', example: 'Exercise is beneficial for health.' },
            { word: 'physical health', ipa: '/Ààf…™z…™kl helŒ∏/', meaning: 's·ª©c kh·ªèe th·ªÉ ch·∫•t', example: 'Sports improve physical health.' },
            { word: 'muscle', ipa: '/Ààm åsl/', meaning: 'c∆° b·∫Øp', example: 'Weightlifting builds muscle.' },
            { word: 'mental health', ipa: '/Ààmentl helŒ∏/', meaning: 's·ª©c kh·ªèe tinh th·∫ßn', example: 'Relaxing is good for mental health.' },
            { word: 'stress hormone', ipa: '/stres Ààh…îÀêm…ô än/', meaning: 'ho√≥c-m√¥n cƒÉng th·∫≥ng', example: 'Exercise reduces stress hormones.' },
            { word: 'cancer', ipa: '/Ààk√¶ns…ô(r)/', meaning: 'b·ªánh ung th∆∞', example: 'Smoking causes cancer.' },
            { word: 'maintain', ipa: '/me…™nÀàte…™n/', meaning: 'duy tr√¨', example: 'Maintain a healthy weight.' },
            { word: 'worth it', ipa: '/w…úÀêŒ∏ …™t/', meaning: 'x·ª©ng ƒë√°ng', example: 'It is hard work but worth it.' }
        ];

        const unit3HealthyQuestions = [
            {
                id: 'u3h-match',
                type: QuestionType.Match,
                title: '1. Vocabulary: Match words with meaning',
                description: 'N·ªëi t·ª´ ti·∫øng Anh v·ªõi nghƒ©a ti·∫øng Vi·ªát.',
                explanation: '√în l·∫°i c√°c t·ª´ v·ª±ng trong ph·∫ßn "Check out the meaning".',
                items: [
                    { id: 'A1', A: 'work out', B: 't·∫≠p th·ªÉ d·ª•c' },
                    { id: 'A2', A: 'beneficial', B: 'c√≥ l·ª£i, c√≥ √≠ch' },
                    { id: 'A3', A: 'mental health', B: 's·ª©c kh·ªèe tinh th·∫ßn' },
                    { id: 'A4', A: 'muscle', B: 'c∆° b·∫Øp' },
                    { id: 'A5', A: 'maintain', B: 'duy tr√¨' },
                    { id: 'A6', A: 'worth it', B: 'x·ª©ng ƒë√°ng' }
                ]
            },
            {
                id: 'u3h-listen-write-1',
                type: QuestionType.ListenWrite,
                title: '2. Listen & Write',
                prompt: 'Nghe v√† vi·∫øt l·∫°i t·ª´ c√≤n thi·∫øu.',
                audioText: 'beneficial',
                display: '/Àåben.…™Ààf…™ É.…ôl/',
                answer: 'beneficial',
                explanation: 'Beneficial (t√≠nh t·ª´): C√≥ l·ª£i.',
            },
            {
                id: 'u3h-listen-write-2',
                type: QuestionType.ListenWrite,
                title: '3. Listen & Write',
                prompt: 'Nghe v√† vi·∫øt l·∫°i t·ª´ c√≤n thi·∫øu.',
                audioText: 'stress hormone',
                display: '/Ààstres Ààh…îÀê.m…ô än/',
                answer: 'stress hormone',
                explanation: 'Stress hormone: Ho√≥c-m√¥n cƒÉng th·∫≥ng.',
            },
            {
                id: 'u3h-reading-mcq-1',
                type: QuestionType.MCQ,
                title: '4. Reading: Why Working Out Is Worth It',
                prompt: 'ƒê·ªçc c√¢u h·ªèi v√† ch·ªçn ƒë√°p √°n ƒë√∫ng d·ª±a tr√™n b√†i ƒë·ªçc.',
                questionText: '1. Which is NOT mentioned in the text as a benefit of sports and exercise?',
                audioText: 'We can avoid some diseases. We can get taller. We can become more energetic.',
                options: [
                    { text: 'A. We can avoid some diseases.', value: 'A' },
                    { text: 'B. We can get taller.', value: 'B' },
                    { text: 'C. We can become more energetic.', value: 'C' }
                ],
                answer: 'B',
                explanation: 'B√†i ƒë·ªçc ƒë·ªÅ c·∫≠p ƒë·∫øn vi·ªác ngƒÉn ng·ª´a b·ªánh t·∫≠t (avoid diseases) v√† tƒÉng nƒÉng l∆∞·ª£ng (boost energy), nh∆∞ng kh√¥ng n√≥i ƒë·∫øn vi·ªác cao h∆°n (get taller).'
            },
            {
                id: 'u3h-reading-mcq-2',
                type: QuestionType.MCQ,
                title: '5. Reading: Confidence',
                prompt: 'ƒê·ªçc c√¢u h·ªèi v√† ch·ªçn ƒë√°p √°n ƒë√∫ng.',
                questionText: '2. According to the text, what can make you feel more confident?',
                options: [
                    { text: 'A. reducing stress', value: 'A' },
                    { text: 'B. having a good appearance', value: 'B' },
                    { text: 'C. sharing our interests', value: 'C' }
                ],
                answer: 'B',
                explanation: 'B√†i ƒë·ªçc n√≥i: "have a good appearance, which can build our confidence" (c√≥ ngo·∫°i h√¨nh ƒë·∫πp gi√∫p x√¢y d·ª±ng s·ª± t·ª± tin).'
            },
            {
                id: 'u3h-reading-mcq-3',
                type: QuestionType.MCQ,
                title: '6. Reading: Teenagers',
                prompt: 'ƒê·ªçc c√¢u h·ªèi v√† ch·ªçn ƒë√°p √°n ƒë√∫ng.',
                questionText: '3. Which is NOT mentioned as a way for teenagers to work out?',
                options: [
                    { text: 'A. taking part in a sports competition', value: 'A' },
                    { text: 'B. joining an after-school sports team', value: 'B' },
                    { text: 'C. doing exercise at home', value: 'C' }
                ],
                answer: 'A',
                explanation: 'B√†i ƒë·ªçc g·ª£i √Ω: "after-school sports team", "fitness club", "exercise at home". Kh√¥ng ƒë·ªÅ c·∫≠p "sports competition".'
            },
            {
                id: 'u3h-true-false',
                type: QuestionType.MCQ,
                title: '7. Reading: True or False?',
                prompt: 'Exercising can bring benefits to our physical health only.',
                options: [
                    { text: 'Right (ƒê√∫ng)', value: 'R' },
                    { text: 'Wrong (Sai)', value: 'W' },
                    { text: 'Doesn\'t Say (Kh√¥ng ƒë·ªÅ c·∫≠p)', value: 'DS' }
                ],
                answer: 'W',
                explanation: 'Sai (Wrong). B√†i ƒë·ªçc n√≥i: "Sports and exercise can also provide great mental health benefits" (c·∫£ l·ª£i √≠ch s·ª©c kh·ªèe tinh th·∫ßn).'
            },
            {
                id: 'u3h-fill-capoeira',
                type: QuestionType.Fill,
                title: '8. Fill in blanks: Capoeira (Workbook Task 3)',
                explanation: 'ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o ƒëo·∫°n vƒÉn v·ªÅ Capoeira.',
                options: ['work', 'physical', 'strengthen', 'maintain', 'get', 'mental', 'reduce', 'boost'],
                questions: [
                    { text: 'Do you want to __ out?', answer: 'work', explanation: 'Work out: t·∫≠p th·ªÉ d·ª•c.' },
                    { text: 'It can improve your __ health.', answer: 'physical', explanation: 'Physical health: s·ª©c kh·ªèe th·ªÉ ch·∫•t.' },
                    { text: 'It helps you __ your body.', answer: 'strengthen', explanation: 'Strengthen your body: l√†m c∆° th·ªÉ kh·ªèe m·∫°nh h∆°n.' },
                    { text: 'And __ a healthy weight.', answer: 'maintain', explanation: 'Maintain: duy tr√¨ (c√¢n n·∫∑ng).' }
                ]
            },
             {
                id: 'u3h-fill-capoeira-2',
                type: QuestionType.Fill,
                title: '9. Fill in blanks: Capoeira (Part 2)',
                explanation: 'ƒêi·ªÅn t·ª´ th√≠ch h·ª£p v√†o ƒëo·∫°n vƒÉn v·ªÅ Capoeira.',
                options: ['get', 'mental', 'reduce', 'boost'],
                questions: [
                    { text: 'Capoeira is a great way to __ fit.', answer: 'get', explanation: 'Get fit: tr·ªü n√™n c√¢n ƒë·ªëi/kh·ªèe m·∫°nh.' },
                    { text: 'It is also good for your __ health.', answer: 'mental', explanation: 'Mental health: s·ª©c kh·ªèe tinh th·∫ßn.' },
                    { text: 'It can __ stress.', answer: 'reduce', explanation: 'Reduce stress: gi·∫£m cƒÉng th·∫≥ng.' },
                    { text: 'Music helps __ their energy.', answer: 'boost', explanation: 'Boost energy: tƒÉng c∆∞·ªùng nƒÉng l∆∞·ª£ng.' }
                ]
            },
            {
                id: 'u3h-scramble-1',
                type: QuestionType.SentenceScramble,
                title: '10. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Sports and exercise can improve our physical health',
                segments: ['improve', 'Sports and exercise', 'our', 'physical health.', 'can'],
                correctOrder: ['Sports and exercise', 'can', 'improve', 'our', 'physical health.'],
                explanation: 'C√¢u ch·ªß ƒë·ªÅ c·ªßa b√†i ƒë·ªçc: Th·ªÉ thao v√† t·∫≠p luy·ªán c√≥ th·ªÉ c·∫£i thi·ªán s·ª©c kh·ªèe th·ªÉ ch·∫•t.',
            },
             {
                id: 'u3h-scramble-2',
                type: QuestionType.SentenceScramble,
                title: '11. Sentence Scramble (Extra Practice)',
                prompt: 'S·∫Øp x·∫øp c√°c t·ª´ th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Staying healthy helps us feel good',
                segments: ['helps us', 'Staying healthy', 'feel good.', 'because it'],
                correctOrder: ['Staying healthy', 'helps us', 'feel good.'], 
                explanation: 'Vi·ªác gi·ªØ s·ª©c kh·ªèe gi√∫p ch√∫ng ta c·∫£m th·∫•y t·ªët h∆°n.',
            },
            // --- NEW SPECIFIC SCRAMBLE QUESTIONS FROM IMAGES ---
            {
                id: 'u3h-q1',
                type: QuestionType.SentenceScramble,
                title: '12. Question Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u h·ªèi ho√†n ch·ªânh.',
                audioText: 'Do you enjoy playing sports or exercising?',
                segments: ['Do you', 'playing sports', 'enjoy', 'or exercising?'],
                correctOrder: ['Do you', 'enjoy', 'playing sports', 'or exercising?'],
                explanation: 'B·∫°n c√≥ th√≠ch ch∆°i th·ªÉ thao hay t·∫≠p th·ªÉ d·ª•c kh√¥ng?',
            },
            {
                id: 'u3h-q2',
                type: QuestionType.SentenceScramble,
                title: '13. Question Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u h·ªèi ho√†n ch·ªânh.',
                audioText: 'What is your favorite sport or physical activity?',
                segments: ["What's", 'your', 'favorite sport', 'or physical activity?'],
                correctOrder: ["What's", 'your', 'favorite sport', 'or physical activity?'],
                explanation: 'M√¥n th·ªÉ thao ho·∫∑c ho·∫°t ƒë·ªông th·ªÉ ch·∫•t y√™u th√≠ch c·ªßa b·∫°n l√† g√¨?',
            },
            {
                id: 'u3h-q3',
                type: QuestionType.SentenceScramble,
                title: '14. Question Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u h·ªèi ho√†n ch·ªânh.',
                audioText: 'How do you feel after exercising or playing sports?',
                segments: ['How do', 'you feel', 'after', 'exercising', 'or playing sports?'],
                correctOrder: ['How do', 'you feel', 'after', 'exercising', 'or playing sports?'],
                explanation: 'B·∫°n c·∫£m th·∫•y th·∫ø n√†o sau khi t·∫≠p th·ªÉ d·ª•c ho·∫∑c ch∆°i th·ªÉ thao?',
            },
            {
                id: 'u3h-q4',
                type: QuestionType.SentenceScramble,
                title: '15. Question Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u h·ªèi ho√†n ch·ªânh.',
                audioText: 'Do you prefer outdoor or indoor sports and activities?',
                segments: ['Do you', 'prefer', 'outdoor', 'or indoor', 'sports and activities?'],
                correctOrder: ['Do you', 'prefer', 'outdoor', 'or indoor', 'sports and activities?'],
                explanation: 'B·∫°n th√≠ch c√°c ho·∫°t ƒë·ªông th·ªÉ thao trong nh√† hay ngo√†i tr·ªùi?',
            },
            {
                id: 'u3h-a1',
                type: QuestionType.SentenceScramble,
                title: '16. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'I really like playing sports and exercising. It is fun and keeps me healthy.',
                segments: ['I really like', 'playing sports', 'and exercising.', "It's fun", 'and', 'keeps me', 'healthy.'],
                correctOrder: ['I really like', 'playing sports', 'and exercising.', "It's fun", 'and', 'keeps me', 'healthy.'],
                explanation: 'T√¥i th·ª±c s·ª± th√≠ch ch∆°i th·ªÉ thao v√† t·∫≠p th·ªÉ d·ª•c. N√≥ vui v√† gi√∫p t√¥i kh·ªèe m·∫°nh.',
            },
            {
                id: 'u3h-a2',
                type: QuestionType.SentenceScramble,
                title: '17. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Basketball is my favorite. I love the teamwork and excitement.',
                segments: ['Basketball', 'is my favorite.', 'I love', 'the teamwork', 'and excitement.'],
                correctOrder: ['Basketball', 'is my favorite.', 'I love', 'the teamwork', 'and excitement.'],
                explanation: 'B√≥ng r·ªï l√† m√¥n y√™u th√≠ch c·ªßa t√¥i. T√¥i y√™u tinh th·∫ßn ƒë·ªìng ƒë·ªôi v√† s·ª± ph·∫•n kh√≠ch.',
            },
            {
                id: 'u3h-a3',
                type: QuestionType.SentenceScramble,
                title: '18. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'I feel great! Even if I am tired, after that, I feel energized and proud.',
                segments: ['I feel great!', "Even if I'm tired,", 'after that,', 'I feel', 'energized', 'and proud.'],
                correctOrder: ['I feel great!', "Even if I'm tired,", 'after that,', 'I feel', 'energized', 'and proud.'],
                explanation: 'T√¥i c·∫£m th·∫•y tuy·ªát v·ªùi! Ngay c·∫£ khi t√¥i m·ªát, sau ƒë√≥ t√¥i c·∫£m th·∫•y tr√†n ƒë·∫ßy nƒÉng l∆∞·ª£ng v√† t·ª± h√†o.',
            },
            {
                id: 'u3h-a4',
                type: QuestionType.SentenceScramble,
                title: '19. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'I like both for different reasons.',
                segments: ['I like', 'both', 'for', 'different reasons.'],
                correctOrder: ['I like', 'both', 'for', 'different reasons.'],
                explanation: 'T√¥i th√≠ch c·∫£ hai v√¨ nh·ªØng l√Ω do kh√°c nhau.',
            },
            {
                id: 'u3h-a5',
                type: QuestionType.SentenceScramble,
                title: '20. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Outdoor sports like soccer and hiking let me enjoy nature and fresh air.',
                segments: ['Outdoor sports', 'like soccer and hiking', 'let me', 'enjoy nature', 'and fresh air.'],
                correctOrder: ['Outdoor sports', 'like soccer and hiking', 'let me', 'enjoy nature', 'and fresh air.'],
                explanation: 'C√°c m√¥n th·ªÉ thao ngo√†i tr·ªùi nh∆∞ b√≥ng ƒë√° v√† ƒëi b·ªô ƒë∆∞·ªùng d√†i cho ph√©p t√¥i t·∫≠n h∆∞·ªüng thi√™n nhi√™n v√† kh√¥ng kh√≠ trong l√†nh.',
            },
            {
                id: 'u3h-a6',
                type: QuestionType.SentenceScramble,
                title: '21. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Indoor sports like basketball and volleyball are great when it is too hot outside.',
                segments: ['Indoor sports', 'like basketball and volleyball', 'are great', 'when it‚Äôs', 'too hot outside.'],
                correctOrder: ['Indoor sports', 'like basketball and volleyball', 'are great', 'when it‚Äôs', 'too hot outside.'],
                explanation: 'C√°c m√¥n th·ªÉ thao trong nh√† nh∆∞ b√≥ng r·ªï v√† b√≥ng chuy·ªÅn r·∫•t tuy·ªát khi b√™n ngo√†i qu√° n√≥ng.',
            },
            {
                id: 'u3h-a7',
                type: QuestionType.SentenceScramble,
                title: '22. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'Playing sports and exercising offers many benefits, but the most important one is staying healthy.',
                segments: ['Playing sports and exercising', 'offers many benefits,', 'but', 'the most important one', 'is staying healthy.'],
                correctOrder: ['Playing sports and exercising', 'offers many benefits,', 'but', 'the most important one', 'is staying healthy.'],
                explanation: 'Ch∆°i th·ªÉ thao v√† t·∫≠p th·ªÉ d·ª•c mang l·∫°i nhi·ªÅu l·ª£i √≠ch, nh∆∞ng quan tr·ªçng nh·∫•t l√† gi·ªØ g√¨n s·ª©c kh·ªèe.',
            },
            {
                id: 'u3h-a8',
                type: QuestionType.SentenceScramble,
                title: '23. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: 'When you move your body through sports and exercise, you make your muscles and bones stronger.',
                segments: ['When you move your body', 'through sports and exercise,', 'you make', 'your muscles and bones', 'stronger.'],
                correctOrder: ['When you move your body', 'through sports and exercise,', 'you make', 'your muscles and bones', 'stronger.'],
                explanation: 'Khi b·∫°n v·∫≠n ƒë·ªông c∆° th·ªÉ th√¥ng qua th·ªÉ thao v√† t·∫≠p th·ªÉ d·ª•c, b·∫°n l√†m cho c∆° b·∫Øp v√† x∆∞∆°ng ch·∫Øc kh·ªèe h∆°n.',
            },
            {
                id: 'u3h-a9',
                type: QuestionType.SentenceScramble,
                title: '24. Sentence Scramble',
                prompt: 'S·∫Øp x·∫øp th√†nh c√¢u ho√†n ch·ªânh.',
                audioText: "When you're healthy and happy, you can do better in school and enjoy life more.",
                segments: ["When you're healthy and happy,", "you can do better in school", "and enjoy life more."],
                correctOrder: ["When you're healthy and happy,", "you can do better in school", "and enjoy life more."],
                explanation: 'Khi b·∫°n kh·ªèe m·∫°nh v√† h·∫°nh ph√∫c, b·∫°n c√≥ th·ªÉ h·ªçc t·ªët h∆°n v√† t·∫≠n h∆∞·ªüng cu·ªôc s·ªëng nhi·ªÅu h∆°n.',
            }
        ];

        // ==========================================
        // MAIN UNITS CONFIG
        // ==========================================
        const units = {
            'unit2': {
                id: 'unit2',
                title: 'Unit 2: Disasters & Accidents',
                icon: 'üåã',
                vocabulary: unit2Vocab,
                questions: unit2Questions
            },
            'unit3_env': {
                id: 'unit3_env',
                title: 'Unit 3: The Environment (Old)',
                icon: 'üåç',
                vocabulary: unit3EnvVocab,
                questions: unit3EnvQuestions
            },
            'unit3_healthy': {
                id: 'unit3_healthy',
                title: 'Unit 3: Healthy Lifestyle (New)',
                icon: 'üèÉ',
                vocabulary: unit3HealthyVocab,
                questions: unit3HealthyQuestions
            }
        };

        // ==========================================
        // 4. COMPONENTS
        // ==========================================

        // --- MCQ Renderer ---
        const MCQRenderer = ({ question, userAnswer, isChecked, onAnswer }) => {
            const handlePlayAudio = () => playTTS(question.audioText || '');

            if (question.type === QuestionType.ListenWrite) {
                return (
                    <div className="flex flex-col items-center space-y-6">
                        <button onClick={handlePlayAudio} className="px-6 py-3 rounded-full font-bold text-white shadow-lg transform transition hover:scale-105 active:scale-95 flex items-center gap-2 bg-pink-500 hover:bg-pink-600">
                            üîä Listen
                        </button>
                        <div className="text-2xl font-mono bg-white px-4 py-2 rounded border border-gray-200 shadow-sm text-slate-600">
                            {question.display}
                        </div>
                        <div className="w-full max-w-md">
                            <input
                                type="text"
                                disabled={isChecked}
                                value={userAnswer || ''}
                                onChange={(e) => onAnswer(e.target.value)}
                                placeholder="Type the word here..."
                                className={`w-full text-center text-xl p-3 border-2 rounded-xl focus:outline-none focus:ring-2 focus:ring-teal-500 transition-colors ${
                                    isChecked 
                                        ? (question.answer.toLowerCase() === (userAnswer || '').toLowerCase().trim() 
                                            ? 'border-green-500 bg-green-50 text-green-800' 
                                            : 'border-red-500 bg-red-50 text-red-800')
                                        : 'border-slate-200'
                                }`}
                            />
                        </div>
                    </div>
                );
            }

            return (
                <div className="space-y-4">
                    {question.audioText && (
                        <div className="flex justify-center mb-6">
                            <button onClick={handlePlayAudio} className="px-4 py-2 rounded-lg font-semibold text-white shadow transition flex items-center gap-2 bg-pink-500 hover:bg-pink-600">
                                üîä Play Audio
                            </button>
                        </div>
                    )}
                    {question.questionText && (
                        <div className="text-lg font-medium text-slate-700 bg-slate-100 p-4 rounded-lg">
                            {question.questionText}
                        </div>
                    )}
                    <div className="grid gap-3">
                        {question.options.map((opt) => {
                            const isSelected = userAnswer === opt.value;
                            const isCorrect = question.answer === opt.value;
                            let className = "relative p-4 rounded-xl border-2 cursor-pointer transition-all duration-200 flex items-center ";
                            
                            if (isChecked) {
                                if (isCorrect) className += "bg-green-100 border-green-500 text-green-900";
                                else if (isSelected) className += "bg-red-100 border-red-500 text-red-900";
                                else className += "bg-white border-slate-200 opacity-60";
                            } else {
                                if (isSelected) className += "bg-teal-50 border-teal-500 ring-1 ring-teal-500";
                                else className += "bg-white border-slate-200 hover:border-teal-300 hover:bg-slate-50";
                            }

                            return (
                                <div key={opt.value} onClick={() => !isChecked && onAnswer(opt.value)} className={className}>
                                    <span className="text-lg" dangerouslySetInnerHTML={{ __html: opt.text }} />
                                    {isChecked && isCorrect && <span className="absolute right-4 text-green-600 text-xl font-bold">‚úì</span>}
                                    {isChecked && isSelected && !isCorrect && <span className="absolute right-4 text-red-600 text-xl font-bold">‚úó</span>}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Match Renderer ---
        const MatchRenderer = ({ question, userAnswer = {}, isChecked, onAnswer }) => {
            const [selectedA, setSelectedA] = useState(null);
            const [shuffledB, setShuffledB] = useState([]);

            useEffect(() => {
                setShuffledB(question.items.map(i => i.B).sort(() => Math.random() - 0.5));
            }, [question]);

            const handleSelectA = (a) => {
                if (isChecked) return;
                if (selectedA === a) setSelectedA(null);
                else if (userAnswer[a]) {
                    const next = { ...userAnswer };
                    delete next[a];
                    onAnswer(next);
                    setSelectedA(a);
                } else {
                    setSelectedA(a);
                }
            };

            const handleSelectB = (b) => {
                if (isChecked || !selectedA) return;
                const next = { ...userAnswer };
                Object.keys(next).forEach(key => {
                    if (next[key] === b) delete next[key];
                });
                next[selectedA] = b;
                onAnswer(next);
                setSelectedA(null);
            };

            return (
                <div className="grid grid-cols-2 gap-4 md:gap-8 select-none">
                    <div className="space-y-3">
                        <h3 className="font-bold text-center text-teal-700 mb-2">English</h3>
                        {question.items.map(item => {
                            const isPaired = !!userAnswer[item.A];
                            const isSelected = selectedA === item.A;
                            const matchedB = userAnswer[item.A];
                            const isCorrect = isChecked && matchedB === item.B;
                            const isWrong = isChecked && matchedB && matchedB !== item.B;

                            let bgClass = "bg-white border-slate-200";
                            if (isChecked) {
                                if (isCorrect) bgClass = "bg-green-100 border-green-500 text-green-900";
                                else if (isWrong) bgClass = "bg-red-100 border-red-500 text-red-900";
                            } else {
                                if (isSelected) bgClass = "bg-yellow-100 border-yellow-500 ring-2 ring-yellow-300";
                                else if (isPaired) bgClass = "bg-blue-50 border-blue-400";
                            }

                            return (
                                <div key={item.A} onClick={() => handleSelectA(item.A)} className={`p-3 md:p-4 rounded-lg border-2 shadow-sm cursor-pointer transition-all ${bgClass}`}>
                                    <span className="font-semibold">{item.A}</span>
                                    {isPaired && !isChecked && <div className="text-xs text-blue-600 mt-1 truncate">‚Üí {matchedB}</div>}
                                </div>
                            );
                        })}
                    </div>
                    <div className="space-y-3">
                        <h3 className="font-bold text-center text-teal-700 mb-2">Vietnamese</h3>
                        {shuffledB.map((text) => {
                            const parentA = Object.keys(userAnswer).find(key => userAnswer[key] === text);
                            const isUsed = !!parentA;
                            let bgClass = "bg-white border-slate-200 hover:bg-slate-50";
                            if (isChecked) {
                                const correctAObj = question.items.find(i => i.B === text);
                                const userPairCorrect = correctAObj && userAnswer[correctAObj.A] === text;
                                if (userPairCorrect) bgClass = "bg-green-100 border-green-500";
                                else if (isUsed) bgClass = "bg-red-100 border-red-500";
                            } else {
                                if (isUsed) bgClass = "bg-slate-100 border-slate-300 text-slate-500";
                                if (selectedA && !isUsed) bgClass = "bg-white border-teal-300 hover:bg-teal-50 cursor-pointer animate-pulse";
                            }
                            return (
                                <div key={text} onClick={() => handleSelectB(text)} className={`p-3 md:p-4 rounded-lg border-2 shadow-sm transition-all ${bgClass} ${!selectedA && !isChecked ? 'cursor-default' : 'cursor-pointer'}`}>
                                    {text}
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Fill Blank Renderer ---
        const FillBlankRenderer = ({ question, userAnswer = {}, isChecked, onAnswer }) => {
            const [activeSlot, setActiveSlot] = useState(null);

            const handleWordSelect = (word) => {
                if (activeSlot === null || isChecked) return;
                const next = { ...userAnswer };
                Object.keys(next).forEach(key => {
                    if (next[Number(key)] === word) delete next[Number(key)];
                });
                next[activeSlot] = word;
                onAnswer(next);
                setActiveSlot(null);
            };

            const usedWords = Object.values(userAnswer);

            return (
                <div className="space-y-6">
                    <div className="bg-slate-100 p-4 rounded-xl border border-slate-200">
                        <h4 className="text-sm font-bold text-slate-500 uppercase tracking-wide mb-3">Word Bank</h4>
                        <div className="flex flex-wrap gap-2">
                            {question.options.map(opt => {
                                const isUsed = usedWords.includes(opt);
                                return (
                                    <button
                                        key={opt}
                                        disabled={isChecked || activeSlot === null}
                                        onClick={() => handleWordSelect(opt)}
                                        className={`px-3 py-1.5 rounded-lg text-sm font-medium transition-all transform
                                            ${isChecked 
                                                ? 'bg-slate-200 text-slate-500 cursor-default' 
                                                : activeSlot !== null
                                                    ? isUsed 
                                                        ? 'bg-slate-200 text-slate-400 scale-95'
                                                        : 'bg-teal-600 text-white shadow-md hover:scale-105 hover:bg-teal-700'
                                                    : 'bg-slate-300 text-slate-600 cursor-not-allowed'
                                            }
                                        `}
                                    >
                                        {opt}
                                    </button>
                                );
                            })}
                        </div>
                    </div>
                    <div className="space-y-3">
                        {question.questions.map((q, idx) => {
                            const currentVal = userAnswer[idx];
                            const isCorrect = isChecked && currentVal === q.answer;
                            const parts = q.text.split('__');
                            return (
                                <div key={idx} className={`p-3 rounded-lg border flex items-start gap-3 ${isChecked ? (isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200') : 'bg-white border-slate-200'}`}>
                                    <span className="font-mono text-slate-400 mt-1">{idx + 1}.</span>
                                    <div className="leading-loose text-lg text-slate-800">
                                        {parts[0]}
                                        <span
                                            onClick={() => !isChecked && setActiveSlot(idx)}
                                            className={`inline-block min-w-[80px] px-2 py-0.5 mx-1 border-b-2 text-center cursor-pointer font-bold transition-colors
                                                ${isChecked
                                                    ? isCorrect 
                                                        ? 'border-green-500 text-green-700' 
                                                        : 'border-red-500 text-red-700'
                                                    : activeSlot === idx 
                                                        ? 'border-teal-500 bg-teal-50 text-teal-800' 
                                                        : 'border-slate-400 bg-slate-50 hover:bg-slate-100'
                                                }
                                            `}
                                        >
                                            {currentVal || '____'}
                                        </span>
                                        {parts[1]}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Text Entry Renderer ---
        const TextEntryRenderer = ({ question, userAnswer = '', isChecked, onAnswer }) => {
            if (question.type === QuestionType.Writing) {
                return (
                    <div className="space-y-4">
                        <textarea
                            disabled={isChecked}
                            value={userAnswer}
                            onChange={(e) => onAnswer(e.target.value)}
                            rows={6}
                            placeholder={question.placeholder}
                            className={`w-full p-4 rounded-xl border-2 focus:ring-2 focus:ring-teal-500 outline-none transition-colors ${isChecked ? 'bg-slate-50 border-slate-300 text-slate-600' : 'bg-white border-slate-200 hover:border-teal-300'}`}
                        />
                        <p className="text-sm text-slate-500 italic">Structure suggestion: If + S + V (present), S + will + V (base form)...</p>
                    </div>
                );
            }
            return (
                <div className="bg-slate-100 p-6 rounded-xl border border-slate-200">
                    <h3 className="text-xl font-medium text-slate-800 mb-4">{question.prefix}</h3>
                    <input
                        type="text"
                        disabled={isChecked}
                        value={userAnswer}
                        onChange={(e) => onAnswer(e.target.value)}
                        placeholder={question.placeholder}
                        className={`w-full p-3 text-lg rounded-lg border-2 focus:ring-2 focus:ring-teal-500 outline-none ${
                            isChecked
                                ? userAnswer.toLowerCase().includes(question.correctAnswer.toLowerCase()) 
                                    ? 'bg-green-50 border-green-500 text-green-900' 
                                    : 'bg-red-50 border-red-500 text-red-900'
                                : 'bg-white border-slate-300'
                        }`}
                    />
                </div>
            );
        };

        // --- Sentence Scramble Renderer ---
        const SentenceScrambleRenderer = ({ question, userAnswer, isChecked, onAnswer }) => {
            const [pool, setPool] = useState([]);

            useEffect(() => {
                if (!userAnswer || userAnswer.length === 0) {
                    setPool([...question.segments].sort(() => Math.random() - 0.5));
                } else {
                    const currentUsed = [...userAnswer];
                    const remaining = [...question.segments];
                    currentUsed.forEach(word => {
                        const idx = remaining.indexOf(word);
                        if (idx > -1) remaining.splice(idx, 1);
                    });
                    setPool(remaining);
                }
            }, [question.id, userAnswer]);

            const handlePlayAudio = () => playTTS(question.audioText || '');

            const moveToAnswer = (word, index) => {
                if (isChecked) return;
                const newPool = [...pool];
                newPool.splice(index, 1);
                setPool(newPool);
                const newAnswer = userAnswer ? [...userAnswer, word] : [word];
                onAnswer(newAnswer);
            };

            const returnToPool = (word, index) => {
                if (isChecked) return;
                const newAnswer = [...userAnswer];
                newAnswer.splice(index, 1);
                onAnswer(newAnswer);
                setPool(prev => [...prev, word]);
            };

            return (
                <div className="flex flex-col items-center space-y-8">
                    <button onClick={handlePlayAudio} className="px-6 py-3 bg-pink-500 hover:bg-pink-600 text-white rounded-full font-bold shadow-md transform hover:scale-105 transition flex items-center gap-2">
                        üîä Nghe c√¢u m·∫´u
                    </button>
                    <div className="w-full min-h-[80px] p-4 bg-slate-100 rounded-xl border-2 border-dashed border-slate-300 flex flex-wrap gap-2 justify-center items-center relative">
                        {!userAnswer?.length && <span className="text-slate-400 absolute select-none pointer-events-none">B·∫•m v√†o c√°c t·ª´ b√™n d∆∞·ªõi ƒë·ªÉ s·∫Øp x·∫øp...</span>}
                        {userAnswer?.map((word, idx) => (
                            <button key={`${word}-${idx}`} onClick={() => returnToPool(word, idx)} disabled={isChecked} className={`px-4 py-2 bg-white border-2 border-teal-500 text-teal-800 rounded-lg shadow-sm font-medium hover:bg-red-50 hover:border-red-400 transition transform active:scale-95 ${isChecked ? 'cursor-default' : 'cursor-pointer'}`}>
                                {word}
                            </button>
                        ))}
                    </div>
                    <div className="flex flex-wrap gap-3 justify-center">
                        {pool.map((word, idx) => (
                            <button key={`${word}-${idx}`} onClick={() => moveToAnswer(word, idx)} disabled={isChecked} className={`px-4 py-2 bg-slate-200 text-slate-700 rounded-lg shadow font-medium hover:bg-teal-100 hover:text-teal-800 transition transform active:scale-95 ${isChecked ? 'opacity-50 cursor-not-allowed' : 'cursor-pointer'}`}>
                                {word}
                            </button>
                        ))}
                    </div>
                    {isChecked && (
                        <div className="text-center mt-2 animate-fadeIn">
                            <p className="text-slate-500 text-sm">Th·ª© t·ª± ƒë√∫ng:</p>
                            <p className="font-bold text-teal-700 text-lg">{question.correctOrder.join(' ')}</p>
                        </div>
                    )}
                </div>
            );
        };

        // --- Question Renderer Dispatcher ---
        const QuestionRenderer = (props) => {
            switch (props.question.type) {
                case QuestionType.Match: return <MatchRenderer {...props} />;
                case QuestionType.Fill: return <FillBlankRenderer {...props} />;
                case QuestionType.MCQ:
                case QuestionType.Listening:
                case QuestionType.ListenWrite: return <MCQRenderer {...props} />;
                case QuestionType.ShortAnswer:
                case QuestionType.Writing: return <TextEntryRenderer {...props} />;
                case QuestionType.SentenceScramble: return <SentenceScrambleRenderer {...props} />;
                default: return <div>Unknown Question Type</div>;
            }
        };

        // --- Quiz Navigation ---
        const QuizNavigation = ({ isChecked, hasPrev, hasNext, onPrev, onNext, onCheck, onHint }) => (
            <div className="mt-8 pt-6 border-t border-slate-100 flex flex-col sm:flex-row justify-between items-center gap-4">
                <button onClick={onHint} disabled={isChecked} className="order-3 sm:order-1 text-sm font-semibold text-orange-500 hover:text-orange-600 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-1 px-4 py-2 hover:bg-orange-50 rounded-lg transition">
                    üí° G·ª£i √Ω (-1 ƒêi·ªÉm)
                </button>
                <div className="order-1 sm:order-2 flex gap-3 w-full sm:w-auto">
                    <button onClick={onPrev} disabled={!hasPrev} className="flex-1 sm:flex-none px-6 py-3 bg-slate-100 text-slate-700 font-semibold rounded-xl hover:bg-slate-200 disabled:opacity-50 disabled:cursor-not-allowed transition">
                        ‚Üê Quay l·∫°i
                    </button>
                    {!isChecked ? (
                        <button onClick={onCheck} className="flex-1 sm:flex-none px-8 py-3 bg-teal-600 text-white font-bold rounded-xl shadow-md hover:bg-teal-700 hover:shadow-lg transform active:scale-95 transition">
                            Ki·ªÉm tra
                        </button>
                    ) : (
                        <button onClick={onNext} className="flex-1 sm:flex-none px-8 py-3 bg-blue-600 text-white font-bold rounded-xl shadow-md hover:bg-blue-700 hover:shadow-lg transform active:scale-95 transition flex items-center justify-center gap-2">
                            {hasNext ? 'C√¢u ti·∫øp theo ‚Üí' : 'Xem k·∫øt qu·∫£ üèÜ'}
                        </button>
                    )}
                </div>
            </div>
        );

        // --- Sidebar ---
        const QuestionListSidebar = ({ totalQuestions, currentIndex, answers, onSelectQuestion }) => (
            <div className="bg-white rounded-2xl shadow-lg p-4 h-fit sticky top-4 border border-slate-100">
                <h3 className="font-bold text-slate-700 mb-4 text-center border-b pb-2">Danh s√°ch c√¢u h·ªèi</h3>
                <div className="grid grid-cols-5 md:grid-cols-3 lg:grid-cols-4 gap-2">
                    {Array.from({ length: totalQuestions }).map((_, idx) => {
                        const status = answers[idx];
                        let btnClass = "w-full aspect-square flex items-center justify-center rounded-lg font-semibold text-sm transition-all duration-200 ";
                        if (currentIndex === idx) btnClass += "bg-teal-600 text-white ring-2 ring-teal-300 ring-offset-1 scale-105 shadow-md";
                        else if (status?.isChecked) {
                            if (status.isCorrect) btnClass += "bg-green-100 text-green-700 border border-green-300 hover:bg-green-200";
                            else btnClass += "bg-red-100 text-red-700 border border-red-300 hover:bg-red-200";
                        } else if (status?.value) btnClass += "bg-blue-50 text-blue-600 border border-blue-200 hover:bg-blue-100";
                        else btnClass += "bg-slate-100 text-slate-500 hover:bg-slate-200";
                        return <button key={idx} onClick={() => onSelectQuestion(idx)} className={btnClass}>{idx + 1}</button>;
                    })}
                </div>
                
                <div className="mt-6 space-y-2 text-xs text-slate-500 px-2">
                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-teal-600 rounded"></div> ƒêang ch·ªçn</div>
                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-green-100 border border-green-300 rounded"></div> ƒê√∫ng</div>
                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-100 border border-red-300 rounded"></div> Sai</div>
                    <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-50 border border-blue-200 rounded"></div> ƒê√£ l√†m</div>
                </div>
            </div>
        );

        // --- Start Screen ---
        const StartScreen = ({ onStart, unitTitle, unitIcon }) => {
            const [name, setName] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if (name.trim().length >= 2) onStart(name.trim());
            };
            return (
                <div className="flex flex-col items-center justify-center min-h-[60vh] text-center px-4">
                    <div className="bg-white p-10 rounded-3xl shadow-2xl max-w-lg w-full transform transition hover:scale-105 duration-300 relative z-20">
                        <div className="text-6xl mb-6 animate-bounce">{unitIcon}</div>
                        <h1 className="text-3xl md:text-4xl font-extrabold text-teal-800 mb-4 transition-all duration-300 min-h-[80px] flex items-center justify-center">
                            {unitTitle}
                        </h1>
                        <p className="text-slate-500 mb-8 text-lg">Ki·ªÉm tra t·ª´ v·ª±ng, nghe v√† ng·ªØ ph√°p c·ªßa b·∫°n.</p>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <input type="text" value={name} onChange={(e) => setName(e.target.value)} placeholder="Nh·∫≠p t√™n c·ªßa b·∫°n..." className="w-full px-5 py-4 rounded-xl border-2 border-slate-200 bg-slate-50 text-lg focus:ring-4 focus:ring-teal-100 focus:border-teal-500 outline-none transition" autoFocus />
                            <button type="submit" disabled={name.trim().length < 2} className="w-full py-4 bg-teal-600 text-white font-bold text-lg rounded-xl shadow-lg hover:bg-teal-700 disabled:opacity-50 disabled:cursor-not-allowed transition">B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                        </form>
                    </div>
                </div>
            );
        };

        // --- Vocabulary Study ---
        const VocabularyStudy = ({ vocabList, onFinish }) => (
            <div className="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden animate-fadeIn">
                <div className="bg-teal-600 p-6 text-center">
                    <h2 className="text-3xl font-bold text-white mb-2">H·ªçc T·ª´ V·ª±ng üìñ</h2>
                    <p className="text-teal-100">Nghe v√† ƒë·ªçc to c√°c t·ª´ v·ª±ng tr∆∞·ªõc khi l√†m b√†i t·∫≠p.</p>
                </div>
                <div className="p-6 md:p-8">
                    <div className="overflow-x-auto">
                        <table className="w-full text-left border-collapse">
                            <thead>
                                <tr className="border-b-2 border-slate-200 text-slate-500 text-sm uppercase tracking-wider">
                                    <th className="py-3 px-4">Nghe</th>
                                    <th className="py-3 px-4">T·ª´ v·ª±ng</th>
                                    <th className="py-3 px-4">Phi√™n √¢m</th>
                                    <th className="py-3 px-4">Nghƒ©a ti·∫øng Vi·ªát</th>
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-slate-100">
                                {vocabList.map((item, idx) => (
                                    <tr key={idx} className="hover:bg-slate-50 transition-colors">
                                        <td className="py-3 px-4">
                                            <button onClick={() => playTTS(item.word)} className="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center hover:bg-pink-200 transition shadow-sm">üîä</button>
                                        </td>
                                        <td className="py-3 px-4 text-lg font-bold text-slate-800">{item.word}</td>
                                        <td className="py-3 px-4 font-mono text-slate-500">{item.ipa}</td>
                                        <td className="py-3 px-4 text-slate-700">{item.meaning}</td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-8 text-center">
                        <button onClick={onFinish} className="px-10 py-4 bg-teal-600 text-white font-bold rounded-xl shadow-lg hover:bg-teal-700 hover:shadow-xl transform transition hover:-translate-y-1 active:scale-95 text-lg">ƒê√£ h·ªçc xong - B·∫Øt ƒë·∫ßu l√†m b√†i t·∫≠p ‚ûî</button>
                    </div>
                </div>
            </div>
        );

        // --- Result Screen ---
        const ResultScreen = ({ playerName, answers, totalQuestions, onRestart }) => {
            let correct = 0;
            let hintsPenalty = 0;
            Object.values(answers).forEach((ans) => {
                if (ans.isCorrect) correct++;
                if (ans.isHintUsed) hintsPenalty++;
            });
            const finalScore = Math.max(0, correct - hintsPenalty);

            return (
                <div className="flex flex-col items-center justify-center min-h-[60vh] px-4 animate-fadeIn">
                    <div className="bg-white p-8 md:p-12 rounded-3xl shadow-xl max-w-2xl w-full text-center">
                        <h2 className="text-3xl font-bold text-slate-800 mb-2">Great Job, {playerName}! üéâ</h2>
                        <p className="text-slate-500 mb-8">You have completed the Quiz.</p>
                        <div className="flex justify-center mb-8">
                            <div className="relative w-40 h-40 flex items-center justify-center rounded-full border-8 border-teal-100 bg-teal-50">
                                <div className="text-center">
                                    <span className="block text-4xl font-black text-teal-700">{finalScore}</span>
                                    <span className="text-sm text-teal-600 font-bold uppercase">Points</span>
                                </div>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4 mb-8 max-w-xs mx-auto">
                            <div className="bg-green-50 p-4 rounded-xl">
                                <div className="text-2xl font-bold text-green-700">{correct}</div>
                                <div className="text-xs text-green-600 font-semibold">Correct</div>
                            </div>
                            <div className="bg-red-50 p-4 rounded-xl">
                                <div className="text-2xl font-bold text-red-700">{totalQuestions - correct}</div>
                                <div className="text-xs text-red-600 font-semibold">Wrong</div>
                            </div>
                        </div>
                        {hintsPenalty > 0 && (
                            <p className="text-sm text-orange-500 mb-6 bg-orange-50 inline-block px-4 py-2 rounded-lg">‚ö†Ô∏è {hintsPenalty} points deducted for hints.</p>
                        )}
                        <button onClick={onRestart} className="px-10 py-4 bg-slate-800 text-white font-bold rounded-xl shadow-lg hover:bg-slate-700 hover:shadow-xl transform transition active:scale-95">Try Again ‚Ü∫</button>
                    </div>
                </div>
            );
        };

        // ==========================================
        // 5. MAIN APP
        // ==========================================
        const App = () => {
            const [gameState, setGameState] = useState('START'); // START, STUDY, PLAYING, RESULT
            const [currentUnitId, setCurrentUnitId] = useState('unit2');
            const [playerName, setPlayerName] = useState('');
            const [currentQuestionIndex, setCurrentQuestionIndex] = useState(0);
            const [answers, setAnswers] = useState({});
            const [showUnitSelection, setShowUnitSelection] = useState(false);
            const [voices, setVoices] = useState([]);
            const [currentVoiceName, setCurrentVoiceName] = useState('');

            const currentUnit = units[currentUnitId] || units['unit2'];
            const quizData = currentUnit.questions;
            const vocabularyList = currentUnit.vocabulary;
            const currentQuestion = quizData[currentQuestionIndex];
            const currentAnswerState = answers[currentQuestionIndex];
            const userAnswerValue = currentAnswerState?.value;
            const isChecked = currentAnswerState?.isChecked || false;

            useEffect(() => {
                const loadVoices = () => {
                    const available = getAvailableVoices();
                    setVoices(available);
                    if (available.length > 0) {
                        const defaultVoice = available.find(v => v.name === 'Google US English') || available[0];
                        setCurrentVoiceName(defaultVoice.name);
                        setPreferredVoice(defaultVoice.name);
                    }
                };
                loadVoices();
                if (window.speechSynthesis.onvoiceschanged !== undefined) {
                    window.speechSynthesis.onvoiceschanged = loadVoices;
                }
            }, []);

            const handleVoiceChange = (e) => {
                const name = e.target.value;
                setCurrentVoiceName(name);
                setPreferredVoice(name);
                playTTS("Hello");
            };

            const handleStart = (name) => {
                setPlayerName(name);
                setGameState('STUDY');
                setCurrentQuestionIndex(0);
                setAnswers({});
            };

            const handleFinishStudy = () => setGameState('PLAYING');
            
            const handleRestart = () => {
                setGameState('START');
                setPlayerName('');
                setAnswers({});
            };

            const handleUnitChange = (unitId) => {
                if (unitId === currentUnitId) {
                    setShowUnitSelection(false);
                    return;
                }
                if (gameState !== 'START') {
                    if (!window.confirm(`B·∫°n c√≥ ch·∫Øc mu·ªën ƒë·ªïi sang b√†i "${units[unitId].title}"? Ti·∫øn ƒë·ªô hi·ªán t·∫°i s·∫Ω b·ªã m·∫•t.`)) return;
                }
                setCurrentUnitId(unitId);
                setCurrentQuestionIndex(0);
                setAnswers({});
                setShowUnitSelection(false);
                if (gameState !== 'START') setGameState('STUDY');
            };

            const handleAnswerUpdate = (val) => {
                setAnswers(prev => ({
                    ...prev,
                    [currentQuestionIndex]: {
                        value: val,
                        isCorrect: false,
                        isChecked: false,
                        isHintUsed: prev[currentQuestionIndex]?.isHintUsed || false
                    }
                }));
            };

            const handleCheck = () => {
                if (!answers[currentQuestionIndex]?.value && currentQuestion.type !== QuestionType.SentenceScramble) return;
                const val = answers[currentQuestionIndex]?.value;
                if (currentQuestion.type === QuestionType.SentenceScramble && (!val || val.length === 0)) return;

                let isCorrect = false;
                switch (currentQuestion.type) {
                    case QuestionType.Match:
                        const correctCount = currentQuestion.items.reduce((acc, item) => acc + (val[item.A] === item.B ? 1 : 0), 0);
                        isCorrect = correctCount === currentQuestion.items.length;
                        break;
                    case QuestionType.Fill:
                        const filledCorrectly = currentQuestion.questions.every((q, idx) => val[idx] === q.answer);
                        const allFilled = Object.keys(val).length === currentQuestion.questions.length;
                        isCorrect = filledCorrectly && allFilled;
                        break;
                    case QuestionType.ShortAnswer:
                    case QuestionType.ListenWrite:
                        isCorrect = val.toLowerCase().trim().includes(currentQuestion.type === QuestionType.ListenWrite ? currentQuestion.answer.toLowerCase() : currentQuestion.correctAnswer.toLowerCase());
                        break;
                    case QuestionType.Writing:
                        isCorrect = val.split(' ').length > 5;
                        break;
                    case QuestionType.MCQ:
                    case QuestionType.Listening:
                        isCorrect = val === currentQuestion.answer;
                        break;
                    case QuestionType.SentenceScramble:
                        if (val.length !== currentQuestion.correctOrder.length) isCorrect = false;
                        else isCorrect = val.every((word, index) => word === currentQuestion.correctOrder[index]);
                        break;
                }

                setAnswers(prev => ({
                    ...prev,
                    [currentQuestionIndex]: { ...prev[currentQuestionIndex], isChecked: true, isCorrect }
                }));

                if (isCorrect && currentQuestion.type === QuestionType.SentenceScramble && currentQuestion.audioText) {
                    setTimeout(() => playTTS(currentQuestion.audioText), 500);
                }
            };

            const handleNext = () => {
                if (currentQuestionIndex < quizData.length - 1) setCurrentQuestionIndex(prev => prev + 1);
                else setGameState('RESULT');
            };

            const handleHint = () => {
                if (!window.confirm("D√πng g·ª£i √Ω s·∫Ω b·ªã tr·ª´ 1 ƒëi·ªÉm. B·∫°n ch·∫Øc ch·∫Øn ch·ª©?")) return;
                let solvedValue = null;
                switch (currentQuestion.type) {
                    case QuestionType.MCQ:
                    case QuestionType.Listening:
                    case QuestionType.ListenWrite:
                        solvedValue = currentQuestion.answer;
                        break;
                    case QuestionType.ShortAnswer:
                        solvedValue = currentQuestion.correctAnswer;
                        break;
                    case QuestionType.Match:
                        const matchSolved = {};
                        currentQuestion.items.forEach(i => matchSolved[i.A] = i.B);
                        solvedValue = matchSolved;
                        break;
                    case QuestionType.Fill:
                        const fillSolved = {};
                        currentQuestion.questions.forEach((q, i) => fillSolved[i] = q.answer);
                        solvedValue = fillSolved;
                        break;
                    case QuestionType.SentenceScramble:
                        solvedValue = currentQuestion.correctOrder;
                        break;
                    case QuestionType.Writing:
                        solvedValue = "Hint used.";
                        break;
                }
                setAnswers(prev => ({
                    ...prev,
                    [currentQuestionIndex]: { value: solvedValue, isChecked: true, isCorrect: true, isHintUsed: true }
                }));
            };

            // Views
            const UnitSelectionModal = () => (
                <div className="fixed inset-0 z-50 flex items-center justify-center bg-black/60 backdrop-blur-sm p-4 animate-fadeIn">
                    <div className="bg-white rounded-2xl shadow-2xl w-full max-w-lg overflow-hidden">
                        <div className="bg-gradient-to-r from-teal-600 to-blue-600 p-5 flex justify-between items-center">
                            <h3 className="text-white font-bold text-xl">üìö Ch·ªçn B√†i H·ªçc</h3>
                            <button onClick={() => setShowUnitSelection(false)} className="text-teal-100 hover:text-white text-3xl">&times;</button>
                        </div>
                        <div className="p-4 grid gap-3 max-h-[70vh] overflow-y-auto bg-slate-50">
                            {Object.values(units).map(u => (
                                <button key={u.id} onClick={() => handleUnitChange(u.id)} className={`flex items-center gap-4 p-4 rounded-xl border-2 text-left group transition-all ${currentUnitId === u.id ? 'border-teal-500 bg-white shadow-md ring-2 ring-teal-200' : 'border-slate-200 bg-white hover:border-teal-300'}`}>
                                    <div className="text-3xl p-3 rounded-lg bg-slate-50">{u.icon}</div>
                                    <div className="flex-1">
                                        <div className="font-bold text-lg text-slate-800">{u.title}</div>
                                        <div className="text-sm text-slate-500 mt-1">{u.questions.length} c√¢u h·ªèi ‚Ä¢ {u.vocabulary.length} t·ª´ v·ª±ng</div>
                                    </div>
                                    {currentUnitId === u.id && <div className="text-teal-500 font-bold text-xl">‚úì</div>}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );

            if (gameState === 'START') {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen bg-slate-50 p-4 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none opacity-40">
                            <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] bg-teal-200 rounded-full blur-[100px] animate-pulse"></div>
                            <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] bg-blue-200 rounded-full blur-[100px] animate-pulse" style={{animationDelay: '1s'}}></div>
                        </div>
                        <div className="w-full max-w-lg mb-8 text-center z-10">
                            <label className="block text-slate-500 font-bold mb-4 uppercase text-sm tracking-widest">Ch·ªçn b√†i h·ªçc ƒë·ªÉ b·∫Øt ƒë·∫ßu</label>
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                {Object.values(units).map(u => (
                                    <button key={u.id} onClick={() => setCurrentUnitId(u.id)} className={`p-5 rounded-2xl border-2 flex flex-col items-center gap-3 transition-all ${currentUnitId === u.id ? 'border-teal-500 bg-white shadow-xl ring-4 ring-teal-100 scale-105' : 'border-slate-200 bg-white/80 hover:bg-white'}`}>
                                        <span className="text-5xl">{u.icon}</span>
                                        <span className="font-bold text-sm text-slate-700">{u.title}</span>
                                    </button>
                                ))}
                            </div>
                        </div>
                        <StartScreen onStart={handleStart} unitTitle={currentUnit.title} unitIcon={currentUnit.icon} />
                    </div>
                );
            }

            if (gameState === 'RESULT') return <ResultScreen playerName={playerName} answers={answers} totalQuestions={quizData.length} onRestart={handleRestart} />;

            return (
                <div className="min-h-screen py-4 px-4 md:px-8 max-w-7xl mx-auto">
                    {showUnitSelection && <UnitSelectionModal />}
                    <header className="flex flex-col md:flex-row justify-between items-center mb-6 gap-4 border-b pb-4 bg-slate-50/50 backdrop-blur-sm sticky top-0 z-20 md:relative">
                        <div className="flex flex-col items-start w-full md:w-auto">
                            <h1 className="text-xl md:text-2xl font-bold text-teal-800 flex items-center gap-2">
                                <span className="text-3xl">{currentUnit.icon}</span> 
                                <span className="truncate">{currentUnit.title}</span>
                            </h1>
                            <button onClick={() => setShowUnitSelection(true)} className="text-xs font-bold text-slate-600 bg-white border border-slate-300 px-3 py-1.5 rounded-lg mt-2 hover:bg-slate-50 hover:text-teal-600 transition flex items-center gap-2 shadow-sm">
                                üîÑ ƒê·ªïi b√†i h·ªçc kh√°c
                            </button>
                        </div>
                        <div className="flex items-center gap-3 w-full md:w-auto justify-end">
                            {gameState !== 'STUDY' && (
                                <button onClick={() => setGameState('STUDY')} className="text-sm font-bold text-teal-700 bg-teal-50 px-3 py-2 rounded-lg border border-teal-200 hover:bg-teal-100 transition shadow-sm flex items-center gap-1">
                                    üìñ <span className="hidden sm:inline">T·ª´ v·ª±ng</span>
                                </button>
                            )}
                            {voices.length > 0 && (
                                <div className="flex items-center gap-2 bg-white border border-slate-200 rounded-lg px-2 py-1 shadow-sm">
                                    <select id="voice-select" value={currentVoiceName} onChange={handleVoiceChange} className="text-sm text-slate-700 bg-transparent outline-none max-w-[100px] sm:max-w-[150px] truncate cursor-pointer">
                                        {voices.map(v => <option key={v.name} value={v.name}>{v.name.replace('Google', '').replace('English', '')}</option>)}
                                    </select>
                                </div>
                            )}
                            <div className="text-sm font-bold text-slate-600 bg-slate-200 px-3 py-2 rounded-full flex items-center gap-1">üë§ {playerName}</div>
                        </div>
                    </header>

                    {gameState === 'STUDY' ? (
                        <VocabularyStudy vocabList={vocabularyList} onFinish={handleFinishStudy} />
                    ) : (
                        <div className="grid grid-cols-1 md:grid-cols-12 gap-6 items-start">
                            <main className="md:col-span-9 bg-white rounded-3xl shadow-xl p-6 md:p-10 min-h-[500px] flex flex-col justify-between transition-all relative">
                                <div>
                                    <div className="flex justify-between items-start mb-6">
                                        <div>
                                            <span className="text-xs font-bold text-teal-600 uppercase tracking-wider bg-teal-50 px-2 py-1 rounded">C√¢u h·ªèi {currentQuestionIndex + 1} / {quizData.length}</span>
                                            <h2 className="text-xl md:text-2xl font-bold text-slate-800 mt-2">{currentQuestion.title}</h2>
                                        </div>
                                    </div>
                                    {currentQuestion.prompt && <p className="text-slate-600 mb-6 italic border-l-4 border-teal-500 pl-4 bg-slate-50 p-2 rounded-r">{currentQuestion.prompt}</p>}
                                    <QuestionRenderer question={currentQuestion} userAnswer={userAnswerValue} isChecked={isChecked} onAnswer={handleAnswerUpdate} />
                                    {isChecked && (
                                        <div className={`mt-6 p-4 rounded-xl border-l-4 ${currentAnswerState?.isHintUsed ? 'bg-yellow-50 border-yellow-500 text-yellow-900' : (currentAnswerState?.isCorrect ? 'bg-green-50 border-green-500 text-green-900' : 'bg-red-50 border-red-500 text-red-900')} animate-fadeIn`}>
                                            <h3 className="font-bold mb-1">{currentAnswerState?.isHintUsed ? 'ƒê√£ d√πng g·ª£i √Ω üí°' : (currentAnswerState?.isCorrect ? 'Ch√≠nh x√°c! üéâ' : 'Ch∆∞a ch√≠nh x√°c üòî')}</h3>
                                            <p dangerouslySetInnerHTML={{ __html: currentQuestion.explanation }} />
                                        </div>
                                    )}
                                </div>
                                <QuizNavigation currentIndex={currentQuestionIndex} totalQuestions={quizData.length} isChecked={isChecked} hasPrev={currentQuestionIndex > 0} hasNext={currentQuestionIndex < quizData.length - 1 || isChecked} onPrev={() => setCurrentQuestionIndex(p => p - 1)} onNext={handleNext} onCheck={handleCheck} onHint={handleHint} />
                            </main>
                            <aside className="md:col-span-3 order-first md:order-last w-full sticky top-20">
                                <QuestionListSidebar totalQuestions={quizData.length} currentIndex={currentQuestionIndex} answers={answers} onSelectQuestion={setCurrentQuestionIndex} />
                            </aside>
                        </div>
                    )}
                </div>
            );
        };

        // ==========================================
        // 6. RENDER
        // ==========================================
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
